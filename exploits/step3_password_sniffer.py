#!/usr/bin/env python3
"""
Step 3: OPC UA íŒ¨ìŠ¤ì›Œë“œ ìŠ¤ë‹ˆí¼
ActivateSession ë©”ì‹œì§€ì—ì„œ í‰ë¬¸ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
"""
import sys
sys.path.insert(0, '/root/opcua-research/python-opcua-env/lib/python3.10/site-packages')

from opcua import Client, ua
import time

def test_password_extraction(server_url, username, password):
    """íŒ¨ìŠ¤ì›Œë“œ ì „ì†¡ ê³¼ì • ì‹œë®¬ë ˆì´ì…˜ ë° ë¶„ì„"""
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘        Step 3: íŒ¨ìŠ¤ì›Œë“œ ìŠ¤ë‹ˆí•‘ í…ŒìŠ¤íŠ¸                         â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print()
    print(f"ğŸ” ëŒ€ìƒ ì„œë²„: {server_url}")
    print(f"ğŸ”‘ í…ŒìŠ¤íŠ¸ ê³„ì •: {username} / {password}")
    print()
    
    try:
        client = Client(server_url)
        
        print("ğŸ“¡ 1ë‹¨ê³„: GetEndpoints ìš”ì²­...")
        client.connect()
        print("   âœ… ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì‹ ")
        print()
        
        print("ğŸ“¡ 2ë‹¨ê³„: CreateSession ìš”ì²­...")
        print("   âœ… ì„¸ì…˜ ìƒì„±")
        print()
        
        print("ğŸ“¡ 3ë‹¨ê³„: ActivateSession ìš”ì²­...")
        print(f"   âš ï¸  Username: '{username}'")
        print(f"   âš ï¸  Password: '{password}'")
        print()
        
        # ì„œë²„ ì •ë³´ í™•ì¸
        objects = client.get_objects_node()
        print("   âœ… ì„¸ì…˜ í™œì„±í™” ì„±ê³µ")
        print()
        
        print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print("ğŸ¯ ì·¨ì•½ì  ë¶„ì„:")
        print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print()
        print("âš ï¸  NoSecurity ì •ì±… ì‚¬ìš© ì‹œ:")
        print("   1. GetEndpoints â†’ í‰ë¬¸ ì „ì†¡")
        print("   2. CreateSession â†’ í‰ë¬¸ ì „ì†¡")
        print("   3. ActivateSession â†’ í‰ë¬¸ íŒ¨ìŠ¤ì›Œë“œ!")
        print()
        print("ğŸ¯ ê³µê²©ìê°€ ìº¡ì²˜ ê°€ëŠ¥:")
        print(f"   â€¢ Username: {username}")
        print(f"   â€¢ Password: {password}")
        print(f"   â€¢ ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ìœ¼ë¡œ ì¦‰ì‹œ íƒˆì·¨ ê°€ëŠ¥!")
        print()
        
        client.disconnect()
        
        return True
        
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: {e}")
        return False

def simulate_network_capture():
    """ë„¤íŠ¸ì›Œí¬ ìº¡ì²˜ ì‹œë®¬ë ˆì´ì…˜"""
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘        ë„¤íŠ¸ì›Œí¬ íŒ¨í‚· ìº¡ì²˜ ì‹œë®¬ë ˆì´ì…˜                          â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print()
    print("ğŸ’¡ ì‹¤ì œ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤:")
    print()
    print("1ï¸âƒ£  ê³µê²©ìê°€ Wireshark/tcpdumpë¡œ ë„¤íŠ¸ì›Œí¬ ëª¨ë‹ˆí„°ë§")
    print("2ï¸âƒ£  í´ë¼ì´ì–¸íŠ¸ê°€ OPC UA ì„œë²„ì— ì—°ê²°")
    print("3ï¸âƒ£  ActivateSession ë©”ì‹œì§€ ìº¡ì²˜")
    print("4ï¸âƒ£  OPC UA í”„ë¡œí† ì½œ ë””ì½”ë”©")
    print("5ï¸âƒ£  í‰ë¬¸ Username/Password ì¶”ì¶œ")
    print()
    print("ğŸ“¦ ìº¡ì²˜ ëª…ë ¹ ì˜ˆì‹œ:")
    print("   tcpdump -i lo -w opcua_capture.pcap port 4841")
    print("   wireshark -k -i lo -f 'tcp port 4841'")
    print()

def main():
    print()
    print("=" * 70)
    print("OPC UA Password Downgrade ê³µê²© - Step 3: íŒ¨ìŠ¤ì›Œë“œ ìŠ¤ë‹ˆí•‘")
    print("=" * 70)
    print()
    
    # í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
    scenarios = [
        ("Python opcua (4841)", "opc.tcp://localhost:4841/freeopcua/server/", "admin", "password123"),
        ("open62541 (4842)", "opc.tcp://localhost:4842/open62541/server/", "user", "secret"),
        ("S2OPC (4840)", "opc.tcp://localhost:4840/S2OPC/server/", "operator", "test1234"),
    ]
    
    for name, url, username, password in scenarios:
        print(f"\n{'='*70}")
        print(f"í…ŒìŠ¤íŠ¸: {name}")
        print(f"{'='*70}\n")
        
        # Anonymous ì—°ê²° í…ŒìŠ¤íŠ¸ (íŒ¨ìŠ¤ì›Œë“œ ì—†ì´)
        print(f"ğŸ”“ Anonymous ì—°ê²° í…ŒìŠ¤íŠ¸...")
        try:
            client = Client(url)
            client.connect()
            print(f"   âœ… Anonymous ì—°ê²° ì„±ê³µ!")
            print(f"   âš ï¸  ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥í•œ ì„œë²„!")
            client.disconnect()
        except Exception as e:
            print(f"   â„¹ï¸  Anonymous ì—°ê²° ë¶ˆê°€: {e}")
        
        print()
    
    # ë„¤íŠ¸ì›Œí¬ ìº¡ì²˜ ê°€ì´ë“œ
    print(f"\n{'='*70}\n")
    simulate_network_capture()
    
    print()
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘                Step 3 ì™„ë£Œ: íŒ¨ìŠ¤ì›Œë“œ ìŠ¤ë‹ˆí•‘ ë¶„ì„              â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print()
    print("ğŸ¯ ë‹¤ìŒ ë‹¨ê³„: Step 4 - ì „ì²´ ê³µê²© ì²´ì¸ êµ¬í˜„")
    print()

if __name__ == "__main__":
    main()
