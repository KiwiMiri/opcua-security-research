#!/usr/bin/env python3
"""
Step 1: OPC UA ν¨ν‚· λ¶„μ„κΈ°
GetEndpoints μ”μ²­/μ‘λ‹µμ„ μΊ΅μ²ν•κ³  λ¶„μ„ν•©λ‹λ‹¤.
"""
import sys
sys.path.insert(0, '/root/opcua-research/python-opcua-env/lib/python3.10/site-packages')

from opcua import Client
from opcua.ua import SecurityPolicyType
import struct

def analyze_endpoints(url):
    """μ„λ²„μ μ—”λ“ν¬μΈνΈ μ •λ³΄λ¥Ό λ¶„μ„"""
    print("β•”β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•—")
    print("β•‘        Step 1: OPC UA μ—”λ“ν¬μΈνΈ λ¶„μ„                         β•‘")
    print("β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•")
    print()
    print(f"π” λ€μƒ μ„λ²„: {url}")
    print()
    
    try:
        client = Client(url)
        
        # GetEndpoints μ”μ²­
        print("π“΅ GetEndpoints μ”μ²­ μ „μ†΅...")
        endpoints = client.connect_and_get_server_endpoints()
        
        print(f"β… μ—”λ“ν¬μΈνΈ μμ‹ : {len(endpoints)}κ°")
        print()
        
        print("β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”")
        print("π“‹ μ—”λ“ν¬μΈνΈ μƒμ„Έ μ •λ³΄:")
        print("β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”")
        
        for i, ep in enumerate(endpoints, 1):
            print(f"\n[μ—”λ“ν¬μΈνΈ {i}]")
            print(f"  URL: {ep.EndpointUrl}")
            print(f"  λ³΄μ• λ¨λ“: {ep.SecurityMode}")
            print(f"  λ³΄μ• μ •μ±…: {ep.SecurityPolicyUri}")
            print(f"  λ³΄μ• λ λ²¨: {ep.SecurityLevel}")
            
            # λ³΄μ• μ •μ±… λ¶„μ„
            if "None" in ep.SecurityPolicyUri:
                print(f"  β οΈ  NoSecurity - ν‰λ¬Έ ν†µμ‹  κ°€λ¥!")
            elif "Basic128" in ep.SecurityPolicyUri:
                print(f"  π”’ Basic128 - μ•½ν• μ•”νΈν™”")
            elif "Basic256" in ep.SecurityPolicyUri:
                print(f"  π” Basic256 - μ¤‘κ°„ μ•”νΈν™”")
            elif "Aes128" in ep.SecurityPolicyUri or "Aes256" in ep.SecurityPolicyUri:
                print(f"  π”π” AES - κ°•λ ¥ν• μ•”νΈν™”")
            
            # μΈμ¦ ν† ν°
            if hasattr(ep, 'UserIdentityTokens'):
                print(f"  μΈμ¦ λ°©μ‹:")
                for token in ep.UserIdentityTokens:
                    print(f"    - {token.TokenType}: {token.PolicyId}")
        
        print()
        print("β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”")
        print("π― Downgrade κ³µκ²© κ°€λ¥μ„± λ¶„μ„:")
        print("β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”")
        
        has_none = any("None" in ep.SecurityPolicyUri for ep in endpoints)
        has_secure = any("Basic256" in ep.SecurityPolicyUri or "Aes" in ep.SecurityPolicyUri for ep in endpoints)
        
        if has_none and has_secure:
            print("β οΈ  μ„ν—: NoSecurityμ™€ κ°•λ ¥ν• λ³΄μ• μ •μ±…μ΄ κ³µμ΅΄!")
            print("   β†’ Downgrade κ³µκ²© κ°€λ¥!")
            print()
            print("π― κ³µκ²© μ‹λ‚λ¦¬μ¤:")
            print("   1. GetEndpoints μ‘λ‹µμ„ κ°€λ΅μ±”")
            print("   2. κ°•λ ¥ν• λ³΄μ• μ •μ±… μ κ±°")
            print("   3. NoSecurityλ§ λ‚¨κΉ€")
            print("   4. ν΄λΌμ΄μ–ΈνΈκ°€ NoSecurity μ„ νƒ")
            print("   5. ν‰λ¬Έ ν¨μ¤μ›λ“ μ „μ†΅ β†’ νƒμ·¨!")
        elif has_none:
            print("β οΈ  NoSecurity μ •μ±… μ‚¬μ© μ¤‘")
            print("   β†’ μ΄λ―Έ ν‰λ¬Έ μ „μ†΅ μ¤‘")
        else:
            print("β… NoSecurity μ •μ±… μ—†μ")
            print("   β†’ Downgrade κ³µκ²© μ–΄λ ¤μ›€")
        
        return endpoints
        
    except Exception as e:
        print(f"β μ¤λ¥: {e}")
        return None

def main():
    print()
    print("=" * 70)
    print("OPC UA Password Downgrade κ³µκ²© - Step 1: ν¨ν‚· λ¶„μ„")
    print("=" * 70)
    print()
    
    # 3κ° μ„λ²„ λ¨λ‘ λ¶„μ„
    servers = [
        ("S2OPC (4840)", "opc.tcp://localhost:4840/S2OPC/server/"),
        ("Python opcua (4841)", "opc.tcp://localhost:4841/freeopcua/server/"),
        ("open62541 (4842)", "opc.tcp://localhost:4842/open62541/server/"),
    ]
    
    results = {}
    for name, url in servers:
        print(f"\n{'='*70}")
        print(f"λ¶„μ„ λ€μƒ: {name}")
        print(f"{'='*70}")
        endpoints = analyze_endpoints(url)
        results[name] = endpoints
        print()
    
    print()
    print("β•”β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•—")
    print("β•‘                Step 1 μ™„λ£: μ—”λ“ν¬μΈνΈ λ¶„μ„ μ™„λ£              β•‘")
    print("β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•")
    print()
    print("π― λ‹¤μ λ‹¨κ³„: Step 2 - MITM ν”„λ΅μ‹ κµ¬ν„")
    print()

if __name__ == "__main__":
    main()
