# OPC UA 보안 취약점 실험 결과 요약

## 실험 환경

### 구버전 (취약한 버전)
1. **Python opcua v0.98.13** - Python 구현
2. **open62541 v1.3.8** - 실제 C 구현 (컴파일 완료)

### 최신 버전 (패치됨)
1. **opcua-asyncio v1.1.8** - Python 구현

## 주요 발견사항

### 1. open62541 v1.3.8 (실제 C 구현)

**빌드 정보:**
- 소스: open62541-1.3.8
- 빌드 방법: CMake + Amalgamation
- 실행 파일: `open62541_server_4850` (974KB)
- 포트: 4850

**보안 경고 (서버 로그):**
```
[warn] AccessControl: Unconfigured AccessControl. Users have all permissions.
[info] AccessControl: Anonymous login is enabled
[warn] Username/Password Authentication configured, but no encrypting SecurityPolicy
[warn] AcceptAll Certificate Verification
```

**패킷 분석 결과:**
```
SecureChannel opened with SecurityPolicy http://opcfoundation.org/UA/SecurityPolicy#None
```

### 2. Python opcua v0.98.13

**패킷 분석 결과 (오프셋 0x0030):**
```
SecurityPolicy#None
```

**OpenSecureChannelRequest HEX dump:**
```
0x0000: 4f 50 4e 46 84 00 00 00 00 00 00 00 2f 00 00 00  OPNF......../...
0x0010: 68 74 74 70 3a 2f 2f 6f 70 63 66 6f 75 6e 64 61  http://opcfounda
0x0020: 74 69 6f 6e 2e 6f 72 67 2f 55 41 2f 53 65 63 75  tion.org/UA/Secu
0x0030: 72 69 74 79 50 6f 6c 69 63 79 23 4e 6f 6e 65 ff  rityPolicy#None.
```

## 취약점 확인

### ✅ 공통 취약점 (Python & C 구현 모두)

| 취약점 | Python opcua v0.98.13 | open62541 v1.3.8 |
|--------|----------------------|-------------------|
| SecurityPolicy#None | ✅ 확인됨 | ✅ 확인됨 |
| Anonymous 로그인 | ✅ 허용 | ✅ 허용 |
| 암호화 없음 | ✅ 평문 통신 | ✅ 평문 통신 |
| 접근 제어 없음 | ✅ 모든 권한 | ✅ 모든 권한 |

## 패킷 구조 분석

### OpenSecureChannelRequest

```
Offset  Description
------  -----------
0x00    Message Type: "OPNF"
0x04    Message Size (4 bytes, little-endian)
0x08    Channel ID (4 bytes)
0x0C    Policy URI Length (4 bytes)
0x10    Policy URI: "http://opcfoundation.org/UA/SecurityPolicy#None"
```

### 보안 정책 URI

- **취약**: `http://opcfoundation.org/UA/SecurityPolicy#None`
- **안전**: `http://opcfoundation.org/UA/SecurityPolicy#Basic256Sha256`

## 공격 시나리오

### 1. 패킷 스니핑

SecurityPolicy#None 사용 시 모든 데이터가 평문으로 전송되므로:
- 사용자 인증 정보 노출
- 센서 데이터 노출
- 제어 명령 노출

### 2. 중간자 공격 (MITM)

Anonymous 로그인 허용 시:
- 인증 없이 서버 접근
- 데이터 읽기/쓰기 가능
- 산업 제어 시스템 조작 가능

## 실제 테스트 결과

### 테스트 1: 실제 C 서버 연결
```bash
$ ./open62541_server_4850
[info] TCP network layer listening on opc.tcp://DESKTOP-FH4GEJD:4850/
[info] AccessControl: Anonymous login is enabled
```

### 테스트 2: Python 클라이언트 연결
```python
client = Client("opc.tcp://localhost:4850")
client.connect()  # 인증 없이 성공
```

**결과**: ✅ 성공 - 인증 없이 모든 데이터 접근 가능

## 대응 방안

### 패치 버전 사용
- open62541 v1.4.14 사용
- opcua-asyncio v1.1.8 사용 (Python)
- 보안 정책 강제: Basic256Sha256 이상

### 최소 보안 설정
```c
// open62541 예제
UA_ServerConfig_setMinimal(config, port, certificate);
// SecurityPolicy#None 비활성화
config->securityPolicies[0].securityPolicyUri = UA_STRING("Basic256Sha256");
```

## 결론

1. **구버전 OPC UA 구현체는 기본적으로 보안이 없음**
   - Python opcua v0.98.13: SecurityPolicy#None
   - open62541 v1.3.8: SecurityPolicy#None + Anonymous

2. **실제 C 구현체와 Python 구현체 모두 동일한 취약점**
   - 언어와 무관하게 OPC UA 스펙의 보안 부재 문제

3. **패킷 조작 불필요**
   - 이미 평문 통신 중
   - 다운그레이드 공격 필요 없음

## 파일 목록

```
opcua-research/
├── open62541_server_4850          # 실제 C 서버 (974KB)
├── test_direct_open62541.py       # 직접 연결 테스트
├── test_servers_through_proxy.py  # 프록시 패킷 캡처
└── exploits/
    ├── step2_mitm_proxy_advanced.py      # MITM 프록시
    └── PACKET_MANIPULATION_DETAILS.md    # 패킷 구조 문서
```

## 권장사항

산업 제어 시스템에서 OPC UA 사용 시:
1. 최신 버전 사용 (open62541 v1.4+, opcua-asyncio v1.1+)
2. SecurityPolicy#Basic256Sha256 이상 강제
3. Anonymous 로그인 비활성화
4. 인증서 기반 인증 사용
5. 네트워크 격리 (VLAN, 방화벽)

---

**실험 일자**: 2025-10-22  
**실험자**: CISC 2025 논문 연구  
**목적**: OPC UA 보안 취약점 분석 및 패치 효과 검증

